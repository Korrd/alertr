{% extends "base.html" %}

{% block title %}SMART{% endblock %}

{% block content %}
<h1>SMART Disk Health</h1>

{% if disks %}
    {% for disk, data in disks.items() %}
    <section class="card disk-card">
        <div class="disk-header">
            <div class="disk-title">
                <h3>{{ disk }}</h3>
                {% if data.health %}
                    {% if data.health[0].value_num == 1 %}
                    <span class="status-badge badge-ok">HEALTHY</span>
                    {% else %}
                    <span class="status-badge badge-crit">FAILING</span>
                    {% endif %}
                {% endif %}
            </div>
            {% if data.info %}
            <div class="disk-info">
                {% if data.info.model %}
                <div class="disk-info-item">
                    <span class="disk-info-label">Model</span>
                    <span class="disk-info-value">{{ data.info.model }}</span>
                </div>
                {% endif %}
                {% if data.info.family %}
                <div class="disk-info-item">
                    <span class="disk-info-label">Family</span>
                    <span class="disk-info-value">{{ data.info.family }}</span>
                </div>
                {% endif %}
                {% if data.info.serial %}
                <div class="disk-info-item">
                    <span class="disk-info-label">Serial</span>
                    <span class="disk-info-value">{{ data.info.serial }}</span>
                </div>
                {% endif %}
                {% if data.info.capacity_human %}
                <div class="disk-info-item">
                    <span class="disk-info-label">Capacity</span>
                    <span class="disk-info-value">{{ data.info.capacity_human }}</span>
                </div>
                {% endif %}
                {% if data.info.firmware %}
                <div class="disk-info-item">
                    <span class="disk-info-label">Firmware</span>
                    <span class="disk-info-value">{{ data.info.firmware }}</span>
                </div>
                {% endif %}
                {% if data.info.interface %}
                <div class="disk-info-item">
                    <span class="disk-info-label">Interface</span>
                    <span class="disk-info-value">{{ data.info.interface }}</span>
                </div>
                {% endif %}
                {% if data.info.form_factor %}
                <div class="disk-info-item">
                    <span class="disk-info-label">Form Factor</span>
                    <span class="disk-info-value">{{ data.info.form_factor }}</span>
                </div>
                {% endif %}
                {% if data.info.rotation_rate %}
                <div class="disk-info-item">
                    <span class="disk-info-label">Type</span>
                    <span class="disk-info-value">
                        {% if data.info.is_ssd %}SSD{% else %}HDD ({{ data.info.rotation_rate }} RPM){% endif %}
                    </span>
                </div>
                {% endif %}
                {% if data.info.power_on_hours %}
                <div class="disk-info-item">
                    <span class="disk-info-label">Power-On</span>
                    <span class="disk-info-value">{{ data.info.power_on_hours | int }} hours ({{ (data.info.power_on_hours / 24) | int }} days)</span>
                </div>
                {% endif %}
            </div>
            {% endif %}
        </div>

        {% if data.attrs %}
        <h4>Key Attributes</h4>
        <div class="grid">
            {% for attr_id, metrics in data.attrs.items() %}
            {% set attr_info = get_attr_info(attr_id | int) %}
            {% set value = metrics[0].value_num | int %}
            {% set is_temp = attr_id | int in [190, 194] %}
            {% set is_critical = attr_info.importance == Importance.CRITICAL and value > 0 and attr_info.higher_is_worse %}
            {% set is_warning = attr_info.importance == Importance.HIGH and value > 0 and attr_info.higher_is_worse %}
            <div class="mini-card">
                <div class="tooltip-wrapper">
                    <div class="attr-name">{{ attr_info.name }}</div>
                    <div class="attr-id">ID {{ attr_id }}</div>
                    <div class="tooltip-content">
                        <div class="tooltip-title">{{ attr_info.name }}</div>
                        <div class="tooltip-id">SMART Attribute #{{ attr_id }}</div>
                        <div class="tooltip-desc">{{ attr_info.description }}</div>
                        <span class="tooltip-importance importance-{{ attr_info.importance.value }}">
                            {{ attr_info.importance.value }} importance
                        </span>
                    </div>
                </div>
                <div class="attr-value {% if is_critical %}value-critical{% elif is_warning %}value-warning{% elif is_temp and value > 50 %}value-warning{% elif is_temp and value > 60 %}value-critical{% else %}value-normal{% endif %}">
                    {{ value }}{% if is_temp %}Â°C{% endif %}
                </div>
                <div class="chart-container-small">
                    <canvas id="attr-{{ disk | replace('/', '-') }}-{{ attr_id }}"></canvas>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </section>
    {% endfor %}
{% else %}
<section class="card">
    <div class="status-notice notice-info">
        <div class="status-notice-icon">ðŸ’¾</div>
        <div class="status-notice-content">
            <div class="status-notice-title">No SMART Data Available</div>
            <div class="status-notice-desc">
                SMART metrics haven't been collected yet. This could mean:
                <ul style="margin-top: 0.5rem; margin-left: 1rem;">
                    <li>The collector hasn't run its first check yet</li>
                    <li>SMART monitoring is disabled in config</li>
                    <li>No disks are configured for monitoring</li>
                </ul>
            </div>
        </div>
    </div>
</section>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
{% for disk, data in disks.items() %}
    {% for attr_id, metrics in data.attrs.items() %}
    (function() {
        const ctx = document.getElementById('attr-{{ disk | replace("/", "-") }}-{{ attr_id }}');
        if (!ctx) return;

        const data = {{ metrics | tojson }};
        const values = data.map(m => m.value_num).reverse().slice(-50);

        // Determine chart color based on importance
        const attrId = {{ attr_id }};
        const criticalAttrs = [5, 184, 187, 196, 197, 198, 220];
        const highAttrs = [10, 188, 189, 199, 201, 202, 224, 227, 230, 231, 232, 233, 235];

        let borderColor = '#6c757d';
        if (criticalAttrs.includes(attrId) && values[values.length - 1] > 0) {
            borderColor = '#dc3545';
        } else if (highAttrs.includes(attrId) && values[values.length - 1] > 0) {
            borderColor = '#fd7e14';
        }

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: values.map((_, i) => i),
                datasets: [{
                    data: values,
                    borderColor: borderColor,
                    borderWidth: 1,
                    pointRadius: 0,
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { display: false },
                    x: { display: false }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });
    })();
    {% endfor %}
{% endfor %}
</script>
{% endblock %}
