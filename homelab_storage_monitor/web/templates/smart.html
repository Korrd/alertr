{% extends "base.html" %}

{% block title %}SMART{% endblock %}

{% block content %}
<h1>SMART Disk Health</h1>

{% if disks %}
    {% for disk, data in disks.items() %}
    <section class="card disk-card">
        <div class="disk-header">
            <div class="disk-title">
                <h3>{{ disk }}</h3>
                {% if data.health %}
                    {% if data.health[0].value_num == 1 %}
                    <span class="status-badge badge-ok">HEALTHY</span>
                    {% else %}
                    <span class="status-badge badge-crit">FAILING</span>
                    {% endif %}
                {% endif %}
            </div>
            {% if data.info %}
            <div class="disk-info">
                {% if data.info.model %}
                <div class="disk-info-item">
                    <span class="disk-info-label">Model</span>
                    <span class="disk-info-value">{{ data.info.model }}</span>
                </div>
                {% endif %}
                {% if data.info.family %}
                <div class="disk-info-item">
                    <span class="disk-info-label">Family</span>
                    <span class="disk-info-value">{{ data.info.family }}</span>
                </div>
                {% endif %}
                {% if data.info.serial %}
                <div class="disk-info-item">
                    <span class="disk-info-label">Serial</span>
                    <span class="disk-info-value">{{ data.info.serial }}</span>
                </div>
                {% endif %}
                {% if data.info.capacity_human %}
                <div class="disk-info-item">
                    <span class="disk-info-label">Capacity</span>
                    <span class="disk-info-value">{{ data.info.capacity_human }}</span>
                </div>
                {% endif %}
                {% if data.info.firmware %}
                <div class="disk-info-item">
                    <span class="disk-info-label">Firmware</span>
                    <span class="disk-info-value">{{ data.info.firmware }}</span>
                </div>
                {% endif %}
                {% if data.info.interface %}
                <div class="disk-info-item">
                    <span class="disk-info-label">Interface</span>
                    <span class="disk-info-value">{{ data.info.interface }}</span>
                </div>
                {% endif %}
                {% if data.info.form_factor %}
                <div class="disk-info-item">
                    <span class="disk-info-label">Form Factor</span>
                    <span class="disk-info-value">{{ data.info.form_factor }}</span>
                </div>
                {% endif %}
                {% if data.info.rotation_rate %}
                <div class="disk-info-item">
                    <span class="disk-info-label">Type</span>
                    <span class="disk-info-value">
                        {% if data.info.is_ssd %}SSD{% else %}HDD ({{ data.info.rotation_rate }} RPM){% endif %}
                    </span>
                </div>
                {% endif %}
                {% if data.info.power_on_hours %}
                <div class="disk-info-item">
                    <span class="disk-info-label">Power-On</span>
                    <span class="disk-info-value">{{ data.info.power_on_hours | natural_time }} ({{ data.info.power_on_hours | int }} hours)</span>
                </div>
                {% endif %}
            </div>
            {% endif %}
        </div>

        {% if data.attrs %}
        <h4>Key Attributes</h4>
        <div class="grid">
            {% for attr_id, metrics in data.attrs.items() %}
            {% set attr_id_int = attr_id | int %}
            {% set attr_info = get_attr_info(attr_id_int) %}
            {% set value = metrics[0].value_num | int %}
            {% set is_temp = attr_id_int in [190, 194, 1001] %}
            {% set is_spinup = attr_id_int == 3 %}
            {% set is_pct = attr_id_int in [1002, 1003] %}
            {% set is_gb = attr_id_int in [1008, 1009] %}
            {% set is_nvme = attr_id_int >= 1000 %}
            {% set is_critical = attr_info.importance == Importance.CRITICAL and value > 0 and attr_info.higher_is_worse %}
            {% set is_warning = attr_info.importance == Importance.HIGH and value > 0 and attr_info.higher_is_worse %}
            {% set spare_low = attr_id_int == 1003 and value < 20 %}
            <div class="mini-card">
                <div class="tooltip-wrapper">
                    <div class="attr-name">{{ attr_info.name }}</div>
                    <div class="attr-id">{% if is_nvme %}NVMe{% else %}ID {{ attr_id }}{% endif %}</div>
                    <div class="tooltip-content">
                        <div class="tooltip-title">{{ attr_info.name }}</div>
                        <div class="tooltip-id">{% if is_nvme %}NVMe Health Metric{% else %}SMART Attribute #{{ attr_id }}{% endif %}</div>
                        <div class="tooltip-desc">{{ attr_info.description }}</div>
                        <span class="tooltip-importance importance-{{ attr_info.importance.value }}">
                            {{ attr_info.importance.value }} importance
                        </span>
                    </div>
                </div>
                <div class="attr-value {% if is_critical %}value-critical{% elif is_warning %}value-warning{% elif spare_low %}value-warning{% elif is_temp and value > 50 %}value-warning{% elif is_temp and value > 60 %}value-critical{% else %}value-normal{% endif %}">
                    {{ value }}{% if is_temp %}Â°C{% elif is_spinup %}ms{% elif is_pct %}%{% elif is_gb %}GB{% endif %}
                </div>
                <div class="chart-container-small">
                    <canvas id="attr-{{ disk | replace('/', '-') }}-{{ attr_id }}"></canvas>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        {# Self-Test & Error Log Section - at bottom #}
        {% if data.selftest %}
        <div class="selftest-section">
            <h4>Self-Test & Error Log</h4>
            <div class="selftest-grid">
                {% if data.selftest.last_short %}
                <div class="selftest-item">
                    <span class="selftest-label">Short Test</span>
                    <span class="selftest-value {% if data.selftest.last_short.passed %}test-passed{% else %}test-failed{% endif %}">
                        {% if data.selftest.last_short.passed %}âœ“ Passed{% else %}âœ— Failed{% endif %}
                    </span>
                    <span class="selftest-detail">
                        {% if data.selftest.last_short.hours_ago is not none %}
                            {{ data.selftest.last_short.hours_ago | int }} hours ago
                        {% endif %}
                    </span>
                </div>
                {% else %}
                <div class="selftest-item">
                    <span class="selftest-label">Short Test</span>
                    <span class="selftest-value test-none">No test run</span>
                </div>
                {% endif %}

                {% if data.selftest.last_long %}
                <div class="selftest-item">
                    <span class="selftest-label">Extended Test</span>
                    <span class="selftest-value {% if data.selftest.last_long.passed %}test-passed{% else %}test-failed{% endif %}">
                        {% if data.selftest.last_long.passed %}âœ“ Passed{% else %}âœ— Failed{% endif %}
                    </span>
                    <span class="selftest-detail">
                        {% if data.selftest.last_long.hours_ago is not none %}
                            {{ data.selftest.last_long.hours_ago | int }} hours ago
                        {% endif %}
                    </span>
                </div>
                {% else %}
                <div class="selftest-item">
                    <span class="selftest-label">Extended Test</span>
                    <span class="selftest-value test-none">No test run</span>
                </div>
                {% endif %}

                <div class="selftest-item">
                    <span class="selftest-label">Error Log</span>
                    {% set is_acked = data.ack and data.ack.error_count_acked >= data.selftest.error_count %}
                    <span class="selftest-value {% if data.selftest.error_count == 0 %}test-passed{% elif is_acked %}test-acked{% else %}test-failed{% endif %}">
                        {% if data.selftest.error_count == 0 %}
                            âœ“ Clean
                        {% elif is_acked %}
                            âœ“ {{ data.selftest.error_count }} error(s) - ACK'd
                        {% else %}
                            {{ data.selftest.error_count }} error(s)
                        {% endif %}
                    </span>
                    {% if data.selftest.error_count > 0 %}
                    <button class="btn-link selftest-detail" onclick="toggleErrorLog('{{ disk | replace('/', '-') }}')">
                        View details
                    </button>
                    {% endif %}
                </div>

                {% if data.selftest.test_count is defined and data.selftest.test_count > 0 %}
                <div class="selftest-item">
                    <span class="selftest-label">Test History</span>
                    <span class="selftest-value test-info">{{ data.selftest.test_count }} test(s) logged</span>
                </div>
                {% endif %}
            </div>

            {# Expandable Error Log Details #}
            {% if data.selftest.error_count > 0 %}
            <div id="error-log-{{ disk | replace('/', '-') }}" class="error-log-details" style="display: none;">
                <div class="error-log-header">
                    <h5>Error Log Entries</h5>
                    {% if data.ack %}
                    <div class="ack-status">
                        <span class="ack-badge">âœ“ Acknowledged</span>
                        <span class="ack-info">by {{ data.ack.acked_by }} on {{ data.ack.acked_at[:10] }}</span>
                        {% if data.ack.note %}
                        <div class="ack-note">Note: {{ data.ack.note }}</div>
                        {% endif %}
                    </div>
                    {% else %}
                    <button class="btn btn-ack" onclick="showAckModal('{{ disk }}', {{ data.selftest.error_count }})">
                        Acknowledge
                    </button>
                    {% endif %}
                </div>

                {% if data.selftest.error_entries %}
                <table class="error-log-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Lifetime Hours</th>
                            <th>State</th>
                            <th>Type</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for entry in data.selftest.error_entries %}
                        <tr>
                            <td>{{ entry.error_number }}</td>
                            <td>{{ entry.lifetime_hours }}</td>
                            <td>{{ entry.state }}</td>
                            <td>{{ entry.type }}</td>
                            <td class="error-detail-cell">{{ entry.details }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p class="text-muted">Error log details not available. Run collector to fetch detailed logs.</p>
                {% endif %}
            </div>
            {% endif %}
        </div>
        {% endif %}
    </section>
    {% endfor %}

{# Acknowledgment Modal #}
<div id="ack-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Acknowledge Errors</h3>
            <button class="modal-close" onclick="hideAckModal()">&times;</button>
        </div>
        <div class="modal-body">
            <p>Acknowledging errors will suppress warnings for this disk's current error count.</p>
            <p><strong>Disk:</strong> <span id="ack-disk-name"></span></p>
            <p><strong>Error Count:</strong> <span id="ack-error-count"></span></p>
            <div class="form-group">
                <label for="ack-note">Note (optional):</label>
                <textarea id="ack-note" placeholder="e.g., False positive from faulty cable at hour 0"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="hideAckModal()">Cancel</button>
            <button class="btn btn-primary" onclick="submitAck()">Acknowledge</button>
        </div>
    </div>
</div>

{% else %}
<section class="card">
    <div class="status-notice notice-info">
        <div class="status-notice-icon">ðŸ’¾</div>
        <div class="status-notice-content">
            <div class="status-notice-title">No SMART Data Available</div>
            <div class="status-notice-desc">
                SMART metrics haven't been collected yet. This could mean:
                <ul style="margin-top: 0.5rem; margin-left: 1rem;">
                    <li>The collector hasn't run its first check yet</li>
                    <li>SMART monitoring is disabled in config</li>
                    <li>No disks are configured for monitoring</li>
                </ul>
            </div>
        </div>
    </div>
</section>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
// Error log toggle
function toggleErrorLog(diskId) {
    const el = document.getElementById('error-log-' + diskId);
    if (el) {
        el.style.display = el.style.display === 'none' ? 'block' : 'none';
    }
}

// Acknowledgment modal
let currentAckDisk = null;
let currentAckErrorCount = 0;

function showAckModal(disk, errorCount) {
    currentAckDisk = disk;
    currentAckErrorCount = errorCount;
    document.getElementById('ack-disk-name').textContent = disk;
    document.getElementById('ack-error-count').textContent = errorCount;
    document.getElementById('ack-note').value = '';
    document.getElementById('ack-modal').style.display = 'flex';
}

function hideAckModal() {
    document.getElementById('ack-modal').style.display = 'none';
    currentAckDisk = null;
    currentAckErrorCount = 0;
}

async function submitAck() {
    if (!currentAckDisk) return;

    const note = document.getElementById('ack-note').value.trim();

    try {
        // Use XMLHttpRequest for better Basic Auth handling
        const xhr = new XMLHttpRequest();
        xhr.open('POST', '/api/smart/acknowledge', true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.withCredentials = true;

        xhr.onload = function() {
            if (xhr.status >= 200 && xhr.status < 300) {
                hideAckModal();
                window.location.reload();
            } else {
                let errorMsg = 'Unknown error';
                try {
                    const data = JSON.parse(xhr.responseText);
                    errorMsg = data.detail || JSON.stringify(data);
                } catch {
                    errorMsg = xhr.statusText || `HTTP ${xhr.status}`;
                }
                alert('Failed to acknowledge: ' + errorMsg);
            }
        };

        xhr.onerror = function() {
            alert('Failed to acknowledge: Network error');
        };

        xhr.send(JSON.stringify({
            disk: currentAckDisk,
            error_count: currentAckErrorCount,
            note: note
        }));
    } catch (err) {
        alert('Failed to acknowledge: ' + err.message);
    }
}

// Close modal on outside click
document.getElementById('ack-modal')?.addEventListener('click', function(e) {
    if (e.target === this) {
        hideAckModal();
    }
});

// Charts
{% for disk, data in disks.items() %}
    {% for attr_id, metrics in data.attrs.items() %}
    (function() {
        const ctx = document.getElementById('attr-{{ disk | replace("/", "-") }}-{{ attr_id }}');
        if (!ctx) return;

        const data = {{ metrics | tojson }};
        const values = data.map(m => m.value_num).reverse().slice(-50);

        // Determine chart color based on importance
        const attrId = {{ attr_id }};
        const criticalAttrs = [5, 184, 187, 196, 197, 198, 220];
        const highAttrs = [10, 188, 189, 199, 201, 202, 224, 227, 230, 231, 232, 233, 235];

        let borderColor = '#6c757d';
        if (criticalAttrs.includes(attrId) && values[values.length - 1] > 0) {
            borderColor = '#dc3545';
        } else if (highAttrs.includes(attrId) && values[values.length - 1] > 0) {
            borderColor = '#fd7e14';
        }

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: values.map((_, i) => i),
                datasets: [{
                    data: values,
                    borderColor: borderColor,
                    borderWidth: 1,
                    pointRadius: 0,
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { display: false },
                    x: { display: false }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });
    })();
    {% endfor %}
{% endfor %}
</script>
{% endblock %}
